<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs title="My Conversations">
  <Require feature="dynamic-height" />
  <Require feature="socialtext" />
  </ModulePrefs>
  <Content type="html">
    <![CDATA[

        <style type="text/css">
            .ws-views__MODULE_ID__ { color: #0e93d8; text-align: right; }
            .ws-contrib__MODULE_ID__ { color: #093; text-align: right; }
            #table__MODULE_ID__ td { line-height: 120%; padding: 2px; }
            #error__MODULE_ID__ { color: #f00; font-weight: bold; }
            li { list-style: none; }
        </style>

        <div id='error__MODULE_ID__'></div>
        <div class='calendarList'>
            <table id="table__MODULE_ID__">
            </table>
        </div>
<script src="/nlw/plugin/gadgets/javascript/madlibs.js"></script>
<script>
var report_url__MODULE_ID__ = "/webplugin/cgi/reports/report.cgi/user_conversations/now/-1week.json";
var people_base__MODULE_ID__ = "/data/people/";
var icon_base__MODULE_ID__ = "/nlw/plugin/gadgets/images/asset-icons/";
var action_to_icon__MODULE_ID__ = new Array();
action_to_icon__MODULE_ID__["comment"] = "page-comments-24.png";
action_to_icon__MODULE_ID__["tag"] = "tag-24.png";
action_to_icon__MODULE_ID__["edit"] = "page-editing-24.png";
action_to_icon__MODULE_ID__["upload_file"] = "page-editing-24.png";

function timestamp_to_iso8601 (timestamp) {
    timestamp = timestamp.replace(/( (\d\d:\d\d:\d\d)(Z|[+-]\d\d))/,
                                  "T$2.000$3");
    if (!timestamp.match(/\d\d:\d\d$/)) {
        timestamp = timestamp.replace(/(\d\d)$/,"$1:00");
    }
    return timestamp;
}

$("#error__MODULE_ID__").ajaxError(function(event, request, settings){
    $(this).html("Error requesting" + settings.url);
});
jQuery.getJSON( report_url__MODULE_ID__, { }, function ( data ) {
  if (data.length == 0) {
      jQuery('<tr>').append(jQuery('<td>').append("No data"));
      gadgets.window.adjustHeight();
      return;
  }
  for (var i=0; i<data.length; i++) {
    var timestamp = data[i][0];
    var user_id = data[i][1];
    var ws_name = data[i][2];
    var ws_title = data[i][3];
    var page_name = data[i][4];
    var page_title = data[i][5];
    var action = data[i][6];
    var icon = action_to_icon__MODULE_ID__[action];

    var evt = {
        actor : { fields : { name: user_id, id: user_id } },
        'object' : 'SOME OBJECT',
        'action' : action + '_page',
        'context' : { 
            'page_title' : page_title, 
            'page_name' : page_name, 
            'workspace_title' : ws_title, 
            'workspace_name' : ws_name 
        },
        'timestamp' : timestamp_to_iso8601(timestamp)
    };
    jQuery('#table__MODULE_ID__').append(
      jQuery('<tr>').append(
        jQuery('<td>').attr("colspan","2").append(
          jQuery('<img style="float:right" height="24" width="24">')
            .attr("src",icon_base__MODULE_ID__ + icon)
        )
        .append(
          jQuery('<img style="float:left" height="27" width="27">')
            .attr("src",people_base__MODULE_ID__ + user_id + "/small_photo")
        )
        .append(
            madlib_render_event(evt,0)
        )
      )
    )
  }
  jQuery('#table__MODULE_ID__ .border:last').remove();
  jQuery('#table__MODULE_ID__ tr:odd').addClass('oddRow');
  gadgets.window.adjustHeight();
});
</script>
    ]]>
  </Content>
</Module>
