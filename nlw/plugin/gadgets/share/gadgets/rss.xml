<Module>
  <ModulePrefs title="__UP_title__">
    <Require feature="dynamic-height" />
    <Require feature="setprefs" />
    <Require feature="settitle" />
    <Require feature="dynamic-height" />
    <Require feature="socialtext" />
  </ModulePrefs>
 <UserPref name="rss_feed" display_name="RSS Feed" default_value="http://www.socialtext.com/blog/feed"/>
 <UserPref name="title" default_value="RSS Viewer" datatype="hidden"/>
 <UserPref name="count" display_name="Items Displayed" datatype="enum" default_value="5">
     <EnumValue value="5"/>
     <EnumValue value="10"/>
     <EnumValue value="15"/>
     <EnumValue value="20"/>
     <EnumValue value="25"/>
 </UserPref>
 <UserPref name="max_desc" display_name="Maximum description characters" datatype="enum" default_value="250">
     <EnumValue value="100"/>
     <EnumValue value="250"/>
     <EnumValue value="0" display_value="Unlimited"/>
 </UserPref>
  <Content type="html">
    <![CDATA[

<style>

  #my__MODULE_ID__-content {
    text-align: left;
    margin-left: 5px;
  }
  .rss_item {
    padding: 5px;  
  }

  .rss_title {
  }
  a {
    text-decoration: none;  
    font-size: 1.2em;
  }
  .rss_body {
    font-size: 1.2em;
  }

</style>
<div id="my__MODULE_ID__-content"></div>
<script>
    var params = {};
    var url = '__UP_rss_feed__';
    var prefs = new gadgets.Prefs();

    if ('__UP_title__')
        gadgets.window.setTitle('__UP_title__');

    function get_title (node) {
        var title = 'Untitled';
        var tit_els = node.getElementsByTagName('title');
        if (tit_els && tit_els.length) {
            title = tit_els[0].textContent;
        }
        return title;
    }

    function get_items (node) {
        var items = [];
        var nodes = node.getElementsByTagName('item');
        for (var i=0; i<nodes.length && i < __UP_count__; i++) {
            var title = nodes[i].getElementsByTagName('title')[0];
            var link  = nodes[i].getElementsByTagName('link')[0];
            var desc  = nodes[i].getElementsByTagName('description')[0];

            var item = {
                title : title ? title.childNodes[0].nodeValue : '',
                link  : link  ? link.childNodes[0].nodeValue : '',
                desc  : ''
            };

            if (desc) {
                var full_desc = item.desc = desc.childNodes[0].nodeValue.replace(/<[^>]+>/g,'');
                if (__UP_max_desc__ && full_desc.length > __UP_max_desc__) {
                    var max = full_desc.indexOf(' ', __UP_max_desc__) + 1;

                    item.desc = full_desc.substr(0,max);
                    item.rest = full_desc.substr(max, full_desc.length - max);
                }
            }

            items.push(item);
        }
        return items;
    }

    var callback = function(xml) {
        var title = get_title(xml.data);
        if (title) {
            gadgets.window.setTitle(title);
            prefs.set('title',title);
        }

        var items = get_items(xml.data);

        var content_node = document.getElementById('my__MODULE_ID__-content');

        for (var i=0; i<items.length; i++) {
            var item = items[i];

            var item_div = document.createElement('div');
            var h4 = document.createElement('h4');
            var a = document.createElement('a');
            var border = document.createElement('div');
            var desc_div = document.createElement('p');

            item_div.className = 'myContent';
            border.className = 'border';
            a.href = item.link
            a.style['text-size'] = '10px';
            a.style['text-decoration'] = 'none';

            desc_div.innerHTML = item.desc;
            if (item.rest) {
                desc_div.innerHTML += '<a href="#" title="' + item.rest + '">...</a>';
            }

            item_div.appendChild(h4);
            h4.appendChild(a);
            a.appendChild(document.createTextNode(item.title));
            item_div.appendChild(desc_div);

            content_node.appendChild(item_div);
            content_node.appendChild(border);
        }
        gadgets.window.adjustHeight();
    }
    gadgets.util.registerOnLoadHandler( function() {
        params.CONTENT_TYPE = "DOM";
        gadgets.io.makeRequest(url, callback, params);
    });
</script>

    ]]>

  </Content>
</Module>
