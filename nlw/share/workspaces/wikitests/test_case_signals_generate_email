| *Comment* | Test Case: Signals Generate Email |  |

* Fixture: SocialWidgets

| set | sge_wiki | sge-workspace-%%start_time%% |
| set | sge_wiki_spaces | sge workspace %%start_time%% |
| set | sge_user | %%sge_wiki%%@%%wikiemail%% |
| set | sge_user_prefix | sge |
| set | sge_user_suffix | %%start_time%% |

| create-workspace | %%sge_wiki%% |  |  |
| create-user | %%sge_user%% | %%password%% |  |
| st-admin | add-member --workspace %%sge_wiki%% --email %%sge_user%% | now has the role |  |
| st-admin | add-member --workspace %%sge_wiki%% --email %%username%% | now has the role |  |

| *Comment* | Test Case: Signals Generate Email send 1st signal, with mention |  |
| st-logoutin | %%username%% | %%password%% |
| open_ok | /st/signals |  |
| wait_for_text_present_ok | Signal | 30000 |
| st-name-widget | 1 | signals |
| st_send_signal_via_activities_widget | signals | `This is the first mention {user: %%sge_user%%}` |

| *Comment* | Test Case: Signals Generate Email send 2nd signal, a private message |  |
| open_ok | /st/signals |  |
| wait_for_text_present_ok | Signal | 30000 |
| wait_for_element_present_ok | //div[@class='private'] | 10000 |
| click_ok | //div[@class='private'] |  |
| wait_for_element_visible_ok | //input[@class='lookahead-prompt'] | 10000 |
| type-lookahead-ok | //input[@class='lookahead-prompt'] | %%sge_user_prefix%% |
| wait_for_element_visible_ok | //div[@class='lookaheadItem']/a[contains(text(),'%%sge_user_suffix%%')] | 10000 |
| st_pause_click | 1000 | //div[@class='lookaheadItem']/a[contains(text(),'%%sge_user_suffix%%')] |
| wait-for-element-visible-ok | //div[@class='message private'] | 10000 |
| text_like | //div[@class='message private'] | You are composing a private message to %%sge_wiki%% |
| st-type_signal | This is just a private message |  |
| click_ok | //a[@class='btn post'] |  |
| wait-for-element-not-present-ok | //div[@class='message private'] | 10000 |
| wait_for_text_present_ok | This is just a private message | 30000 |

| *Comment* | Test Case: Signals Generate Email send 3rd signal, a private message with a mention |  |
| open_ok | /st/signals |  |
| wait_for_text_present_ok | Signal | 30000 |
| wait_for_element_present_ok | //div[@class='private'] | 10000 |
| click_ok | //div[@class='private'] |  |
| wait_for_element_visible_ok | //input[@class='lookahead-prompt'] | 10000 |
| type-lookahead-ok | //input[@class='lookahead-prompt'] | %%sge_user_prefix%% |
| wait_for_element_visible_ok | //div[@class='lookaheadItem']/a[contains(text(),'%%sge_user_suffix%%')] | 10000 |
| st_pause_click | 1000 | //div[@class='lookaheadItem']/a[contains(text(),'%%sge_user_suffix%%')] |
| wait-for-element-visible-ok | //div[@class='message private'] | 10000 |
| text_like | //div[@class='message private'] | You are composing a private message to %%sge_wiki%% |
| st-type_signal | `This is a PM with a mention of {user: %%sge_user%%}` |  |
| click_ok | //a[@class='btn post'] |  |
| wait-for-element-not-present-ok | //div[@class='message private'] | 10000 |
| wait_for_text_present_ok | This is a PM with a mention of | 30000 |

| *Comment* | Test Case: Signals Generate Email wait 90 seconds for email delivery |  |
| pause | 90000 |  |

| *Comment* | Test Case: Signals Generate Email verify the contents of the received emails |  |
| open_ok | /%%sge_wiki%%/signal_mention_by_%%short_username%% |  |
| wait_for_text_present_ok | Signal mention by %%short_username%% | 30000 |
| text_like | You were mentioned by %%short_username%%: |  |
| text_like | This is the first mention %%sge_wiki_spaces%% |  |
| text_like | This message was sent by Socialtext Signals. You can reply to this message here. |  |
| text_like | To stop receiving Socialtext Signals emails or to change your preferences, please visit your settings. |  |
| open_ok | /%%sge_wiki%%/%%short_username%%_sent_you_a_private_message |  |
| wait_for_text_present_ok | %%short_username%% sent you a private message | 30000 |
| text_like | You have received a private message from %%short_username%%: |  |
| text_like | This is just a private message |  |
| text_like | Reply privately to this signal. |  |
| text_like | This message was sent from Socialtext Signals. |  |
| text_like | To stop receiving Socialtext Signals emails or to change your preferences, please visit your settings. |  |
| text_like | This is a PM with a mention of %%sge_wiki_spaces%% |  |
| text_like | qr/You have received.+You have received/ |  |
| text_like | qr/sent from Socialtext.+sent from Socialtext/ |  |

| *Comment* | Test Case: Signals Generate Email verify that only two emails were received |  |
| open_ok | /%%sge_wiki%%/?action=recent_changes |  |
| wait_for_text_present_ok | Originally created by | 30000 |
| text_like | st-listview-form | qr/%%sge_wiki%%.+%%sge_wiki%%/ |
| text_unlike | st-listview-form | qr/%%sge_wiki%%.+%%sge_wiki%%.+%%sge_wiki%%/ |

| *Comment* | Test Case: Signals Generate Email check the links included in the email |  |
| open_ok | /%%sge_wiki%%/signal_mention_by_%%short_username%% |  |
| wait_for_element_visible_ok | link=here | 30000 |
| click_ok | link=here |  |
| pause | 20000 |  |
| selectWindow | Socialtext Signals - Permalink |  |
| wait_for_text_present_ok | Signals - Permalink | 30000 |
| wait_for_text_present_ok | This is the first mention | 30000 |
| open_ok | /%%sge_wiki%%/signal_mention_by_%%short_username%% |  |
| wait_for_element_visible_ok | link=your settings | 30000 |
| click_ok | link=your settings |  |
| pause | 20000 |  |
| selectWindow | Signals |  |
| wait_for_text_present_ok | Mentions of Me | 30000 |
| wait_for_text_present_ok | Private Messages | 30000 |

| *Comment* | Test Case: Signals Generate Email TEARDOWN |  |
| deactivate-user | %%sge_user%% |  |
| delete-workspace | %%sge_wiki%% |  |

| *Comment* | Test Case: Signals Generate Email COMPLETED |  |
