#!/bin/bash

# We only need to run this migration if the database differs
# from the schema we expect to have
MIGDIR=`dirname $0`
DB_USER=`st-config echo db_user`
DB_SCHEMA=`st-config echo db_schema_name`
FOUND=0

# Make sure all the tables exist.
for table in event event_id_seq person tag tag_id_seq person_watched_people__person tag_people__person_tags; do
    RESULT=`sudo -u postgres psql $DB_SCHEMA -c "SELECT relname FROM pg_class WHERE relname = '$table'" | grep '1 row'`

  if [ -n "$RESULT" ]; then
      FOUND=$(($FOUND + 1))
  fi
done

if [ $FOUND == 7 ]; then
  echo "Socialtext People tables are installed, Skipping migration."
  exit 1
fi

if [ $FOUND == 0 ]; then
  echo "Socialtext People tables are not installed, Running migration."
  exit 0
fi

echo "Something is very wrong, please contact Socialtext at support@socialtext.com ASAP!"
exit -1
