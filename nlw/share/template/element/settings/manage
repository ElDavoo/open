<script language="javascript">

jQuery(document).ready(function() {
    var newUsers = [];

    function renderNewUsers() {
        var ul = jQuery('<ul>');
        for (var i in newUsers) {
            li = jQuery('<li>')
              .append(newUsers[i].best_full_name)
              .append('<span><a id="' + newUsers[i].user_id + '" href="#" class="remove">x</a></span>')
              .append('<input type="hidden" name="workspace.do.invite_user" value="' + newUsers[i].user_id + '">'); 
            ul.append(li);
        }
        jQuery('#newUsers').html(ul.html());

        // Bind the remove icon to remove the user from the list
        jQuery('#newUsers a.remove').click(function() {
            var user_id = $(this).attr('id');
            newUsers = $.grep(newUsers, function(u) {
                return user_id != u.user_id;
            });
            renderNewUsers();
            return false;
        });
    };

    jQuery('#user').lookahead({
        url: '/data/users',
        clearOnHide: true,
        requireMatch: true,
        params: {accept: 'application/json'},
        linkText: function (user) {
            return [user.best_full_name, user.user_id];
        },
        getEntryThumbnail: function(user) {
            return '/data/people/' + user.value + '/small_photo';
        },
        displayAs: function(user) { return user.title; },
        onAccept: function(id, item) {
            newUsers.push({best_full_name: item.title, user_id: item.value});
            renderNewUsers();
        },
    });

    jQuery(".lookahead-prompt").one('click', function() {
        $(this).val('');
    });
});

</script>

<h3>[% loc('Invite New Users') %]</h3>

[% IF invite_errors %]
<div class="grid_12">
  <p>[% loc('') %]</p>
  [% FOREACH error IN invite_errors.keys %]
    [% IF error == 'ACCOUNT DOMAIN FILTER' %]
      <p>[% loc('The following users were not invited because their email domain does not match [_1].', space.domain_restriction) %]</p>
    [% ELSIF error == 'WORKSPACE INVITATION FILTER' %]
      <p>[% loc('The following users were not invited because their email address does not match the workspace invite filter "[_1]".', space.invitation_filter) %]</p>
    [% ELSIF error == 'USER DELETED' %]
      <p>[% loc('The following users were not invited because they have been deleted. If you wish to invite the users you first need to undelete them.') %]</p>
    [% ELSIF error == 'WORKSPACE RESTRICT TO REGISTERED' %]
      <p>[% loc('The following users were not invited because they are not registered users of Socialtext.') %]</p>
    [% ELSIF error == 'INVALID EMAIL ADDRESS' %]
      <p>[% loc('The following email addresses are not valid.') %]</p>
    [% ELSE %]
      <p>[% loc('They following users generated a [_1] error when attempting to invite.', error) %]</p>
    [% END %]
    [% PROCESS list_of_emails emails=invite_errors.$error %]
  [% END %]
</div>
[% END %]

<div>FIXME: show a list of groups that are in the workspace, remind the admin that they could, if they so wanted, invite users to the group(s) instead</div>

<p>List restrictions on users showing up in lookahead</p>

<div class="grid_5 input-label">
  [% loc('Email addresses to invite') %]:
</div>
<div class="grid_7">
    <input id="user" name="please.ignore.me"
      class="lookahead-prompt" type="text" value="begin typing name here..."/>

    <div class="users" id="newUsers">
    </div>
</div>
<div class="clear"></div>

<hr />

[% IF space.auw_for %]
  <div class="grid_12">
    [% loc('Note: All users of the [_1] account are members of this workspace.', space.auw_for) %]
  </div>
  <div class="clear"></div>
[% END %]

[% IF space.users.size > 0 %]
<div class="grid_12">
  <h3>[% loc('Manage Users') %]</h3>
  <table>
    <tr>
      <th class="first">[% loc('do.remove') %]</th>
      <th>[% loc('user.email-address') %]</th>
      <th>[% loc('user.admin') %]</th>
      <th class="last">[% loc('password.reset') %]</th>
    </tr>

  [% FOREACH user_and_role IN space.users %]
    [% user = user_and_role.0 %]
    [% role = user_and_role.1 %]

    <tr>
      <td class="first">
        <input type="checkbox" value="[% user.user_id %]"
          name="workspace.do.remove_user" />
      </td>
      <td>[% user.name_and_email | html %] </td>
      <td>
        <input type="checkbox" value="[% user.user_id %]"
         name="workspace.do.should_be_admin"
         [% IF role.name == 'admin' %]checked="checked"[% END %]
        />
        <input type="hidden" value="[% user.user_id %].[% role.role_id %]"
          name="workspace.do.valid_user" />
      </td>
      <td class="last">
        <input type="checkbox" value="[% user.user_id %]"
          name="workspace.do.reset_password"
          [% UNLESS user.can_update_store %]disabled="disabled"[%END%]
        />
      </td>
  </tr>

  [% END %]
  </table>
</div>
<div class="clear"></div>

<hr />
[% END %]

[% IF space.groups.size > 0 %]
<div class="grid_12">
  <h3>[% loc('Manage Groups') %]</h3>

  <table>
    <tr>
      <th class="first">[% loc('group.name') %]</th>
      <th>[% loc('config.users') %]</th>
      <th class="last">[% loc('user.role') %]</th>
    </tr>

  [% FOREACH group_and_role IN space.groups %]
    [% group = group_and_role.0 %]
    [% role = group_and_role.1 %]

    <tr>
      <td class="first">[% group.driver_group_name | html %]</td>
      <td>[% group.user_count %]</td>
      <td class="last">[% role.name | html %]</td>
    </tr>

  [% END %]

  </table>
</div>
<div class="clear"></div>

<hr />
[% END %]

[% BLOCK  list_of_emails %]
  <p>[% message %]</p>
  <ul>
  [% FOR email IN emails %]
    <li>[% email | html %]</li>
  [% END %]
  </ul>
[% END %]
