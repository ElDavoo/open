#!/usr/bin/perl
# @COPYRIGHT@
use strict;
use warnings;
use FindBin;
use lib "$FindBin::Bin/../lib";
use Socialtext::Workspace;
use Socialtext::Hub;
use Socialtext::CLI;
use Fatal qw/opendir closedir chdir open/;

$| = 1; # turn on autoflush

die "Must be run as root!\n" if $<;
Socialtext::CLI->_drop_privs();

my $workspaces = Socialtext::Workspace->All;
while ( my $wksp = $workspaces->next ) {
    print "Storing preview text for workspace " . $wksp->name . ": ";
    my $hub = Socialtext::Hub->new(current_workspace => $wksp);
    my $workspace_dir = Socialtext::Paths::page_data_directory($wksp->name);
    chdir $workspace_dir;
    opendir(my $dfh, $workspace_dir);
    while (my $dir = readdir($dfh)) {
        next unless -d $dir;
        next if $dir =~ m/^\./;

        my $page = $hub->pages->new_from_name($dir);
        if ($page->metadata->{Summary}) {
            print '.';
            next;
        }
        print '+';
        eval {
            $page->_store_preview_text($page->preview_text);
        };
        warn "Error storing preview text: $@" if $@;
    }
    closedir($dfh);
    print "\n";
}



