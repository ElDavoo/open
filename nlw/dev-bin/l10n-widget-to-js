#!/usr/bin/perl
# @COPYRIGHT@
use strict;
use warnings;
use YAML;

my $in_file = "share/javascript/Widgets.yaml";
my $out_js_file = "share/javascript/widget_resource.js";

my $marklist = {
    'title' => '\$',
    'image_text' => '%',
};

my $newtext;

print "Loading Widget.yaml file...";

my $yaml = YAML::LoadFile($in_file);
my $widgets = $yaml->{widgets};

print "ok\n";
print "Writing widget_resouce.js...";

open FH, "> " . $out_js_file;
print FH "<!-- This file is auto-generated by l10n-widget-to-file -->\n";

for my $widget_type (@$widgets) {
    my $text = $yaml->{'widget'}->{$widget_type}->{'title'};
    if ( ref $text ) {
        $text = $yaml->{'widget'}->{$widget_type}->{'title'}->{'default'};
        if ( defined $text) {
            $newtext = extract_text('title',  $text ); 
            print FH $newtext . "\n";
        }
        $text = $yaml->{'widget'}->{$widget_type}->{'title'}->{'full'};
        if ( defined $text ) {
            $newtext = extract_text('title',  $text );
            print FH $newtext . "\n";
        }
    }else{
        $newtext = extract_text('title',  $text );
        print FH $newtext . "\n";
    }
}

for my $widget_type (@$widgets) {
    foreach my $x (@{$yaml->{'widget'}->{$widget_type}->{'image_text'}}){
        my $text = $x->{'text'};
        if ( defined $text ) {
            $newtext = extract_text( 'image_text', $text );
            print FH $newtext . "\n";
        }
    }
}

close FH;

print "ok\n";
print "Finished\n";

sub extract_text
{
    my $type = shift;
    my $text = shift;

    my $newtext = $text; 
    my $newtext_args = "";

    my $mark = $marklist->{$type};
    my @params = $text =~ /${mark}(\w+)/g;

    my $count = 1;
    foreach my $param (@params)
    {
        $newtext =~ s/${mark}$param/[_$count]/;
        $newtext_args .= ", $param";
        $count++;
    }

    if ($newtext_args ne "") {
        $newtext = "loc(\"" . $newtext . "\"" . $newtext_args . ")";
    }else{
        $newtext = "loc(\"" . $newtext . "\")";
    }

    return $newtext;
}
