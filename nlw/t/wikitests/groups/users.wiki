Tests for [Story: Groups ReST API]

* Fixture: SocialRest

| standard-test-setup |

# Create a new group, make sure it shows up

| set               | group_name     | group%%start_time%%                    |              |
| create-group      | %%group_name%% | %%account%%                            | %%username%% |
| set               | jenny          | jenny%%start_time%%@ken.socialtext.net |              |
| create-user       | %%jenny%%      | password                               |              |
| add-user-to-group | %%jenny%%      | %%group_id%%                           |              |

## visible by Group Creator (Creator sees Groups he created or is a member of)

| GET         | /data/groups/%%group_id%% |         |
| code-is     | 200                       |         |
| header-like | Cache-Control             | private |
| json-parse  |                           |         |
| Body-like   | "group_id":"%%group_id%%" |         |
| Body-like   | "name":"%%group_name%%"   |         |
| body-like   | "user_count":"1"          |         |
| body-like   | "workspace_count":"0"     |         |
| body-unlike | "members"                 |         |

| GET             | /data/groups/%%group_id%%/users |         |
| code-is         | 200                             |         |
| header-like     | Cache-Control                   | private |
| json-parse      |                                 |         |
| json-array-size | 1                               |         |
| body-like       | %%jenny%%                       |         |

# Fetching a non-existent group = 404

| GET             | /data/groups/2342343434/users |         |
| code-is         | 404                             |         |
| header-like     | Cache-Control                   | private |

## ... visible by Business Admin (Business Admin can see all Groups)

| set            | badmin     | badmin%%start_time%%@ken.socialtext.net |
| create-user    | %%badmin%% | password                                |
| http-user-pass | %%badmin%% | password                                |

| set-business-admin | %%badmin%%                | 1       |
| GET                | /data/groups/%%group_id%%/users |         |
| code-is            | 200                       |         |
| header-like        | Cache-Control             | private |
| json-parse         |                           |         |
| json-array-size | 1 | |
| body-like | %%jenny%% |

| set-business-admin | %%badmin%%                | 0       |
| GET                | /data/groups/%%group_id%%/users |         |
| header-like        | Cache-Control             | private |
| code-is            | 404                       |         |

## visible by Group Members (Members see Groups they are members of)
## *not* visible by other Users (can't see Groups you have no relationship to)

| set            | jane     | jane%%start_time%%@ken.socialtext.net |
| create-user    | %%jane%% | password                              |
| http-user-pass | %%jane%% | password                              |

| GET             | /data/groups/%%group_id%%/users |         |
| code-is         | 404                       |         |
| header-like     | Cache-Control             | private |

| add-user-to-group | %%jane%%                        | %%group_id%% |
| GET               | /data/groups/%%group_id%%/users |              |
| code-is           | 200                             |              |
| header-like       | Cache-Control                   | private      |
| json-parse        |                                 |              |
| json-array-size   | 2                               |              |
| body-like | %%jenny%% |
| body-like | %%jane%% |


## Add Users to Groups via ReST

| set-business-admin | %%badmin%%        | 1           |              |
| http-user-pass     | %%badmin%%        | password    |              |
| create-group       | add%%start_time%% | %%account%% | %%username%% |

| *Comment*   | Create the User, Add User to Group with defaults |                                        |
| set         | jimmy                                            | jimmy%%start_time%%@ken.socialtext.net |
| create-user | %%jimmy%%                                        | password                               |
| POST_json   | /data/groups/%%group_id%%/users                  | {"username":"%%jimmy%%"}               |
| code-is     | 201                                              |                                        |

| *Comment*   | Create the User, Add User to Group with explicit role_name |                                               |
| set         | jorge                                                      | jorge%%start_time%%@ken.socialtext.net        |
| create-user | %%jorge%%                                                  | password                                      |
| POST_json   | /data/groups/%%group_id%%/users                            | {"username":"%%jorge%%","role_name":"member"} |
| code-is     | 201                                                        |                                               |

| *Comment* | Add User to Group with bad json |    |
| POST_json | /data/groups/%%group_id%%/users | {} |
| code-is   | 400                             |    |

| *Comment* | Add User to Group with bad username |                                       |
| POST_json | /data/groups/%%group_id%%/users     | {"username":"nosuchuser@example.com"} |
| code-is   | 400                                 |                                       |

| *Comment* | Add User to Group with bad role_name |                                                        |
| POST_json | /data/groups/%%group_id%%/users      | {"username":"%%jorge%%","role_name":"workspace_admin"} |
| code-is   | 400                                  |                                                        |

| *Comment*       | Verify Users are in Group         |         |
| GET             | /data/groups/%%group_id%%/users |         |
| code-is         | 200                             |         |
| header-like     | Cache-Control                   | private |
| json-parse      |                                 |         |
| json-array-size | 2                               |         |
| body-like       | %%jimmy%%                       |         |
| body-like       | %%jorge%%                       |         |
