* Fixture: SocialRest

| standard-test-setup |

## Setup: Create a group, add an admin and two users (mercury, zinc); cobalt is not in the group.
| *Comment*         | Set up Group, membership |                                            |       |
| set               | group_name               | group%%start_time%%                        |       |
| create-group      | %%group_name%%           | %%account%%                                |       |
| set               | admin                    | admin%%start_time%%@ken.socialtext.net     |       |
| create-user       | %%admin%%                | password                                   |       |
| set               | admin_id                 | %%user_id%%                                |       |
| add-user-to-group | %%admin_id%%             | %%group_id%%                               | admin |
| set               | mercury                  | mercury%%start_time%%@ken.socialtext.net   |       |
| create-user       | %%mercury%%              | password                                   |       |
| set               | mercury_id               | %%user_id%%                                |       |
| add-user-to-group | %%mercury_id%%           | %%group_id%%                               |       |
| set               | zinc                     | zinc%%start_time%%@ken.socialtext.net      |       |
| create-user       | %%zinc%%                 | password                                   |       |
| set               | zinc_id                  | %%user_id%%                                |       |
| add-user-to-group | %%zinc_id%%              | %%group_id%%                               |       |
| set               | cobalt                   | cobalt%%start_time%%@ken.socialtext.net    |       |
| create-user       | %%cobalt%%               | password                                   |       |
| set               | cobalt_id                | %%user_id%%                                |       |
################################################################################

################################################################################
| *Comment* | POST, Group Not Found     |                                                   |
| POST-json | /data/groups/0/membership | {"user_id":"%%mercury_id%%", "role_name":"admin"} |
| code-is   | 404                       |                                                   |

Assumes devnull1 or whoever the default login is *isn't* in this group:

| *Comment* | POST, User devnull1 does not have admin privs |                                                   |
| POST-json | /data/groups/%%group_id%%/membership          | {"user_id":"%%mercury_id%%", "role_name":"admin"} |
| code-is   | 403                                           |                                                   |

| *Comment*      | Log in as a Group admin |          |
| http-user-pass | %%admin%%               | password |

| *Comment* | GET membership returns a 405         |
| GET-json  | /data/groups/%%group_id%%/membership |
| code-is   | 405                                  |

| *Comment*       | Check that Mercury is currently a member             |
| GET-json        | /data/groups/%%group_id%%/users                      |
| code-is         | 200                                                  |
| json-parse      |                                                      |
| json-array-size | 3                                                    |
| json-like       | [{"user_id":"%%mercury_id%%", "role_name":"member"}] |

| *Comment* | Adjust Mercury from member to admin  |                                                   |
| POST-json | /data/groups/%%group_id%%/membership | {"user_id":"%%mercury_id%%", "role_name":"admin"} |
| code-is   | 200                                  |                                                   |

| *Comment*       | Check that Mercury is now an admin                  |
| GET-json        | /data/groups/%%group_id%%/users                     |
| code-is         | 200                                                 |
| json-parse      |                                                     |
| json-array-size | 3                                                   |
| json-like       | [{"user_id":"%%mercury_id%%", "role_name":"admin"}] |

| *Comment* | Adjust Mercury from admin to member  |                                                  |
| POST-json | /data/groups/%%group_id%%/membership | {"username":"%%mercury%%", "role_name":"member"} |
| code-is   | 200                                  |                                                  |

| *Comment*  | Check that Mercury is a member again                 |
| GET-json   | /data/groups/%%group_id%%/users                      |
| code-is    | 200                                                  |
| json-parse |                                                      |
| json-like  | [{"user_id":"%%mercury_id%%", "role_name":"member"}] |

| *Comment* | Adjust Mercury into an invalid role  |                                            |
| POST-json | /data/groups/%%group_id%%/membership | {"username":"%%mercury%%", "role_name":""} |
| code-is   | 400                                  |                                            |

| *Comment*  | Check that Mercury is still a member                 |
| GET-json   | /data/groups/%%group_id%%/users                      |
| code-is    | 200                                                  |
| json-parse |                                                      |
| json-like  | [{"user_id":"%%mercury_id%%", "role_name":"member"}] |

| *Comment* | Adjust Cobalt, not part of the group |                                                   |
| POST-json | /data/groups/%%group_id%%/membership | {"user_id":"%%cobalt_id%%", "role_name":"member"} |
| code-is   | 400                                  |                                                   |

| *Comment*   | Check that Cobalt is still not a member        |
| GET-json    | /data/groups/%%group_id%%/users                |
| code-is     | 200                                            |
| json-parse  |                                                |
| json-unlike | [{"user_id":"%%cobalt_id%%"}] |

| *Comment* | Adjust three people at once; should fail as a batch |                                                                                                                                               |
| POST-json | /data/groups/%%group_id%%/membership                | [{"username":"%%mercury%%", "role_name":"admin"},{"username":"%%zinc%%", "role_name":"admin"},{"username":"%%cobalt%%", "role_name":"admin"}] |
| code-is   | 400                                                 |                                                                                                                                               |

| *Comment*   | Check that everything stayed as-is after rollback    |
| GET-json    | /data/groups/%%group_id%%/users                      |
| code-is     | 200                                                  |
| json-parse  |                                                      |
| json-like   | [{"user_id":"%%mercury_id%%", "role_name":"member"}] |
| json-like   | [{"user_id":"%%zinc_id%%", "role_name":"member"}]    |
| json-unlike | [{"user_id":"%%cobalt_id%%"}]                        |

| *Comment* | Adjust two people at once; should work as a batch |                                                                                      |
| POST-json | /data/groups/%%group_id%%/membership              | [{"username":"%%mercury%%", "role_name":"admin"},{"username":"%%zinc%%", "role_name":"admin"}] |
| code-is   | 200                                               |                                                                                      |

| *Comment*   | Check that everything works as expected             |
| GET-json    | /data/groups/%%group_id%%/users                     |
| code-is     | 200                                                 |
| json-parse  |                                                     |
| json-like   | [{"user_id":"%%mercury_id%%", "role_name":"admin"}] |
| json-like   | [{"user_id":"%%zinc_id%%", "role_name":"admin"}]    |
| json-unlike | [{"user_id":"%%cobalt_id%%"}]                       |

| *Comment* | Try to remove all admins                       |                                                                                                                                                |
| POST-json | /data/groups/%%group_id%%/membership           | [{"username":"%%admin%%","role_name":"member"},{"username":"%%mercury%%", "role_name":"member"},{"username":"%%zinc%%", "role_name":"member"}] |
| code-is   | 409                                            |                                                                                                                                                |
| body-like | The group needs to include at least one admin. |                                                                                                                                                |

| *Comment*   | Try to remove all admins: check for rollback        |
| GET-json    | /data/groups/%%group_id%%/users                     |
| code-is     | 200                                                 |
| json-parse  |                                                     |
| json-like   | [{"user_id":"%%mercury_id%%", "role_name":"admin"}] |
| json-like   | [{"user_id":"%%zinc_id%%", "role_name":"admin"}]    |
| json-unlike | [{"user_id":"%%cobalt_id%%"}]                       |
