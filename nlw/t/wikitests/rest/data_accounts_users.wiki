Tests for [Story: User can be member of multiple accounts]

* Fixture: SocialRest

| standard-test-setup |           |                                      |
| set                 | user2     | u2-%%start_time%%@ken.socialtext.net |
| create-user         | %%user2%% | password                             |
| set                 | user2_id  | %%user_id%%                          |
| set                 | users_uri | /data/accounts/%%account%%/users     |

# Add a user without being a business admin

| POST_json           | %%users_uri%% | {"username":"%%user2%%"}       |
| code-is             | 403           |                                     |

# Add a user as a business admin

| set-business-admin | %%username%% | 1 |
| POST_json | %%users_uri%% | {"username":"%%user2%%"} |
| code-is | 201 |

# Adding a user again should still be 201

| POST_json | %%users_uri%% | {"username":"%%user2%%"} |
| code-is | 201 |

# Other errors give 400

| POST_json | %%users_uri%% | {"username":"bad-user@example.com"} |
| code-is | 400 |
| POST_json | %%users_uri%% | {"username":"bad-user@example.} |
| code-is | 400 |

# Remove from account via username, but fail b/c not a business admin

| set-business-admin | %%username%%            | 0 |
| DELETE             | %%users_uri%%/%%user2%% |   |
| code-is            | 403                     |   |

# Remove from account via username

| set-business-admin | %%username%%            | 1 |
| DELETE             | %%users_uri%%/%%user2%% |   |
| code-is            | 204                     |   |
| DELETE             | %%users_uri%%/%%user2%% |   |
| code-is            | 400                     |   |

# Attempting to remove a user from their primary account is 400

| DELETE  | %%users_uri%%/%%username%% |
| code-is | 400                        |

# Deleting a bad user

| DELETE  | %%users_uri%%/bad-user@example.com |
| code-is | 400                                |


# Adding and Removing via Email address

| POST_json | %%users_uri%%           | {"email_address":"%%user2%%"} |
| code-is   | 201                     |                               |
| DELETE    | %%users_uri%%/%%user2%% |                               |
| code-is   | 204                     |                               |

# Adding and Removing via user_id

| POST_json | %%users_uri%%              | {"user_id":"%%user2_id%%"} |
| code-is   | 201                        |                            |
| DELETE    | %%users_uri%%/%%user2_id%% |                            |
| code-is   | 204                        |                            |

# Test getting the list of users
| set            | notamember     | notamember-%%start_time%%@ken.socialtext.net |             |
| create-user    | %%notamember%% | password                                     |             |
| http-user-pass | %%notamember%% | password                                     |             |
| set            | isamember      | isamember-%%start_time%%@ken.socialtext.net  |             |
| create-user    | %%isamember%%  | password                                     | %%account%% |

| http-user-pass | %%notamember%%                   | password |
| GET-json       | /data/accounts/%%account%%/users |          |
| code-is        | 403                              |          |

| http-user-pass  | %%isamember%%                    | password      |
| GET-json        | /data/accounts/%%account%%/users |               |
| code-is         | 200                              |               |
| json-parse      |                                  |               |
| json-array-size | 2                                |               |
| json-path-is    | $[0].username                    | %%username%%  |
| json-path-is    | $[1].username                    | %%isamember%% |
