Test case for `/data/events`(GET and POST).

* Fixture: SocialRest

| *Comment*       | Clear all events |                  |
| set             | workspace        | admin            |
| st-clear-events |                  |                  |
| get             | /data/events     | application/json |
| code-is         | 200              |                  |
| has-header      | Cache-Control    | qr/private/      |
| body-like       | []               |                  |

| get        | /data/events |          |
| has-header | Content-Type | qr/html/ |
| body-like  | <html>       |          |

| get        | /data/events | text/plain      |
| has-header | Content-Type | qr/text\/plain/ |
| body-like  | qr/^$/       |                 |

| Comment   | POST a few events |                                                                                                                                                        |
| post-json | /data/events      | {"actor":{"id":1},"event_class":"person","action":"tag_add","person":{"id":2},"tag_name":"downer"}                                                     |
| code-is   | 201               |                                                                                                                                                        |
| post-json | /data/events      | {"actor":{"id":1},"tag_name":"taggy","page":{"workspace_name":"%%workspace%%","id":"meeting_agendas"},"event_class":"page","action":"tag_add"}         |
| code-is   | 201               |                                                                                                                                                        |
| post-json | /data/events      | {"actor":{"id":2},"tag_name":"saggy","page":{"workspace_name":"%%workspace%%","id":"announcements_and_links"},"event_class":"page","action":"tag_add"} |
| code-is   | 201               |                                                                                                                                                        |
| post-json | /data/events      | {"actor":{"id":2},"tag_name":"taggy","page":{"workspace_name":"%%workspace%%","id":"quick_start"},"event_class":"page","action":"tag_add"}             |
| code-is   | 201               |                                                                                                                                                        |

| Comment    | GET all events as JSON         |                  |
| get        | /data/events                   | application/json |
| code-is    | 200                            |                  |
| has-header | Cache-Control                  | qr/private/      |
| body-like  | "id":"quick_start"             |                  |
| body-like  | "id":"meeting_agendas"         |                  |
| body-like  | "id":"announcements_and_links" |                  |

| Comment    | GET all events as text/plain                                          |                 |
| get        | /data/events                                                          | text/plain      |
| has-header | Content-type                                                          | qr/text\/plain/ |
| code-is    | 200                                                                   |                 |
| body-like  | qr/Guest User tagged Quick Start in Admin Wiki as taggy/              |                 |
| body-like  | qr/Guest User tagged Announcements and Links in Admin Wiki as saggy./ |                 |
| body-like  | qr/System User tagged Meeting agendas in Admin Wiki as taggy./        |                 |
| body-like  | qr/System User tagged System User downer./                            |                 |

| Comment    | GET all events as text/html                                                    |                |
| get        | /data/events                                                                   | text/html      |
| has-header | Content-type                                                                   | qr/text\/html/ |
| code-is    | 200                                                                            |                |
| body-like  | qr/Guest User.*tagged.*Quick Start.*in.*Admin Wiki.*as.*taggy.*\./             |                |
| body-like  | qr/Guest User.*tagged.*Announcements and Links.*in.*Admin Wiki.*as.*saggy.*\./ |                |
| body-like  | qr/System User.*tagged.*Meeting agendas.*in.*Admin Wiki.*as.*taggy.*\./        |                |
| body-like  | qr/System User.*tagged.*System User.*downer.*\./                               |                |

| Comment     | GET one event (limit)          |                  |
| get         | /data/events?limit=1           | application/json |
| code-is     | 200                            |                  |
| has-header  | Cache-Control                  | qr/private/      |
| body-like   | "event_class":"page"           |                  |
| body-like   | "action":"tag_add"             |                  |
| body-like   | "tag_name":"taggy"             |                  |
| body-like   | "id":"quick_start"             |                  |
| body-unlike | "id":"meeting_agendas"         |                  |
| body-unlike | "id":"announcements_and_links" |                  |

| Comment     | GET one event as text/plain(limit)                                    |             |
| get         | /data/events?limit=1                                                  | text/plain  |
| code-is     | 200                                                                   |             |
| has-header  | Cache-Control                                                         | qr/private/ |
| body-like   | qr/Guest User tagged Quick Start in Admin Wiki as taggy/              |             |
| body-unlike | qr/Guest User tagged Announcements and Links in Admin Wiki as saggy./ |             |

| Comment     | GET one event as text/html(limit)                                              |             |
| get         | /data/events?limit=1                                                           | text/html   |
| code-is     | 200                                                                            |             |
| has-header  | Cache-Control                                                                  | qr/private/ |
| body-like   | qr/Guest User.*tagged.*Quick Start.*in.*Admin Wiki.*as.*taggy.*\./             |             |
| body-unlike | qr/Guest User.*tagged.*Announcements and Links.*in.*Admin Wiki.*as.*saggy.*\./ |             |

| Comment     | GET one event (count)          |                  |
| get         | /data/events?count=1           | application/json |
| code-is     | 200                            |                  |
| has-header  | Cache-Control                  | qr/private/      |
| body-like   | "event_class":"page"           |                  |
| body-like   | "action":"tag_add"             |                  |
| body-like   | "tag_name":"taggy"             |                  |
| body-like   | "id":"quick_start"             |                  |
| body-unlike | "id":"meeting_agendas"         |                  |
| body-unlike | "id":"announcements_and_links" |                  |

| Comment     | GET one event as text/plain(count)                                    |             |
| get         | /data/events?count=1                                                  | text/plain  |
| code-is     | 200                                                                   |             |
| has-header  | Cache-Control                                                         | qr/private/ |
| body-like   | qr/Guest User tagged Quick Start in Admin Wiki as taggy/              |             |
| body-unlike | qr/Guest User tagged Announcements and Links in Admin Wiki as saggy./ |             |

| Comment     | GET one event as text/html(count)                                              |             |
| get         | /data/events?count=1                                                           | text/html   |
| code-is     | 200                                                                            |             |
| has-header  | Cache-Control                                                                  | qr/private/ |
| body-like   | qr/Guest User.*tagged.*Quick Start.*in.*Admin Wiki.*as.*taggy.*\./             |             |
| body-unlike | qr/Guest User.*tagged.*Announcements and Links.*in.*Admin Wiki.*as.*saggy.*\./ |             |

| Comment     | GET one event (offset)         |                  |
| get         | /data/events?count=1&offset=1  | application/json |
| code-is     | 200                            |                  |
| has-header  | Cache-Control                  | qr/private/      |
| body-like   | "event_class":"page"           |                  |
| body-like   | "action":"tag_add"             |                  |
| body-like   | "tag_name":"saggy"             |                  |
| body-unlike | "id":"quick_start"             |                  |
| body-unlike | "id":"meeting_agendas"         |                  |
| body-like   | "id":"announcements_and_links" |                  |

| Comment     | GET one event as text/plain(offset)                                   |             |
| get         | /data/events?count=1&offset=1                                         | text/plain  |
| code-is     | 200                                                                   |             |
| has-header  | Cache-Control                                                         | qr/private/ |
| body-unlike | qr/Guest User tagged Quick Start in Admin Wiki as taggy/              |             |
| body-like   | qr/Guest User tagged Announcements and Links in Admin Wiki as saggy./ |             |
| body-unlike | qr/System User tagged Meeting agendas in Admin Wiki as taggy./        |             |

| Comment     | GET one event as text/plain(offset)                                            |             |
| get         | /data/events?count=1&offset=1                                                  | text/html   |
| code-is     | 200                                                                            |             |
| has-header  | Cache-Control                                                                  | qr/private/ |
| body-unlike | qr/Guest User.*tagged.*Quick Start.*in.*Admin Wiki.*as.*taggy.*\./             |             |
| body-like   | qr/Guest User.*tagged.*Announcements and Links.*in.*Admin Wiki.*as.*saggy.*\./ |             |
| body-unlike | qr/System User.*tagged.*Meeting agendas.*in.*Admin Wiki.*as.*taggy.*\./        |             |

| Comment     | Filter by event_class           |                  |
| get         | /data/events?event_class=page   | application/json |
| code-is     | 200                             |                  |
| has-header  | Cache-Control                   | qr/private/      |
| body-like   | "id":"quick_start"              |                  |
| body-like   | "id":"meeting_agendas"          |                  |
| body-like   | "id":"announcements_and_links"  |                  |
| get         | /data/events?event_class=monkey | application/json |
| code-is     | 200                             |                  |
| has-header  | Cache-Control                   | qr/private/      |
| body-unlike | "id":"quick_start"              |                  |
| body-unlike | "id":"meeting_agendas"          |                  |
| body-unlike | "id":"announcements_and_links"  |                  |

| Comment   | Filter by follower_id                      |                       |
| get       | /data/events?event_class=person&followed=1 | application/json      |
| code-is   | 200                                        |                       |
| body-like | []                                         |                       |
| post-json | /data/people/3/watchlist                   | {"person":{"id":"1"}} |
| get       | /data/events?event_class=person&followed=1 | application/json      |
| code-is   | 200                                        |                       |
| body-like | "tag_name":"downer"                        |                       |
| delete    | /data/people/3/watchlist/1                 |                       |

| Comment     | Filter by action               |                  |
| get         | /data/events?action=tag_add    | application/json |
| code-is     | 200                            |                  |
| has-header  | Cache-Control                  | qr/private/      |
| body-like   | "id":"quick_start"             |                  |
| body-like   | "id":"meeting_agendas"         |                  |
| body-like   | "id":"announcements_and_links" |                  |
| get         | /data/events?action=edit_save  | application/json |
| code-is     | 200                            |                  |
| has-header  | Cache-Control                  | qr/private/      |
| body-unlike | "id":"quick_start"             |                  |
| body-unlike | "id":"meeting_agendas"         |                  |
| body-unlike | "id":"announcements_and_links" |                  |

| Comment     | Filter by actor.id             |                  |
| get         | /data/events?actor.id=1        | application/json |
| code-is     | 200                            |                  |
| has-header  | Cache-Control                  | qr/private/      |
| body-like   | "tag_name":"downer"            |                  |
| body-like   | "id":"meeting_agendas"         |                  |
| get         | /data/events?actor.id=999999   | application/json |
| code-is     | 200                            |                  |
| has-header  | Cache-Control                  | qr/private/      |
| body-unlike | "tag_name":"downer"            |                  |
| body-unlike | "id":"quick_start"             |                  |
| body-unlike | "id":"meeting_agendas"         |                  |
| body-unlike | "id":"announcements_and_links" |                  |

| Comment     | Filter by person.id           |                  |
| get         | /data/events?person.id=2      | application/json |
| code-is     | 200                           |                  |
| has-header  | Cache-Control                 | qr/private/      |
| body-like   | "tag_name":"downer"           |                  |
| get         | /data/events?person.id=999999 | application/json |
| code-is     | 200                           |                  |
| has-header  | Cache-Control                 | qr/private/      |
| body-unlike | "tag_name":"downer"           |                  |

| Comment          | Filter by workspace_id                          |                            |
| get              | /data/workspaces/%%workspace%%                  | application/json           |
| set-from-content | workspace_id                                    | qr/"workspace_id":"(\d+)"/ |
| get              | /data/events?page.workspace_id=%%workspace_id%% | application/json           |
| code-is          | 200                                             |                            |
| has-header       | Cache-Control                                   | qr/private/                |
| body-like        | "id":"quick_start"                              |                            |
| body-like        | "id":"meeting_agendas"                          |                            |
| body-like        | "id":"announcements_and_links"                  |                            |
| get              | /data/events?page.workspace_id=999999           | application/json           |
| code-is          | 200                                             |                            |
| has-header       | Cache-Control                                   | qr/private/                |
| body-unlike      | "id":"quick_start"                              |                            |
| body-unlike      | "id":"meeting_agendas"                          |                            |
| body-unlike      | "id":"announcements_and_links"                  |                            |

| Comment     | Filter by workspace_name                            |                  |
| get         | /data/events?page.workspace_name=%%workspace%%      | application/json |
| code-is     | 200                                                 |                  |
| has-header  | Cache-Control                                       | qr/private/      |
| body-like   | "id":"quick_start"                                  |                  |
| body-like   | "id":"meeting_agendas"                              |                  |
| body-like   | "id":"announcements_and_links"                      |                  |
| get         | /data/events?page.workspace_name=bad-workspace-name | application/json |
| code-is     | 404                                                 |                  |
| body-like   | not found                                           |                  |
| body-unlike | "id":"quick_start"                                  |                  |
| body-unlike | "id":"meeting_agendas"                              |                  |
| body-unlike | "id":"announcements_and_links"                      |                  |

| *Comment*        | Actor defaults to logged-in user      |                                                                                   |
| st-clear-events  |                                       |                                                                                   |
| post-json        | /data/events                          | {"event_class":"person","action":"tag_add","person":{"id":2},"tag_name":"downer"} |
| code-is          | 201                                   |                                                                                   |
| get              | /data/people/%%username%%             | application/json                                                                  |
| code-is          | 200                                   |                                                                                   |
| has-header       | Cache-Control                         | qr/private/                                                                       |
| set-from-content | actor_id                              | qr/"id":"(\d+)"/                                                                  |
| get              | /data/events?limit=1                  | application/json                                                                  |
| code-is          | 200                                   |                                                                                   |
| has-header       | Cache-Control                         | qr/private/                                                                       |
| body-like        | qr/"actor":{[^}]*"id":"%%actor_id%%"/ |                                                                                   |

| *Comment* | Posting with missing parameters                  |                                                                                                                         |
| post-json | /data/events                                     | {"actor":{"id":1},"action":"tag_add","person":{"id":2},"tag_name":"downer"}                                             |
| code-is   | 400                                              |                                                                                                                         |
| body-like | Missing required parameter 'event_class'         |                                                                                                                         |
| post-json | /data/events                                     | {"actor":{"id":1},"event_class":"person","person":{"id":2},"tag_name":"downer"}                                         |
| code-is   | 400                                              |                                                                                                                         |
| body-like | Missing required parameter 'action'              |                                                                                                                         |
| post-json | /data/events                                     | {"actor":{"id":1},"event_class":"person","action":"tag_add","tag_name":"downer"}                                        |
| code-is   | 400                                              |                                                                                                                         |
| body-like | Missing required parameter 'person.id'           |                                                                                                                         |
| post-json | /data/events                                     | {"actor":{"id":1},"tag_name":"taggy","page":{"workspace_name":"%%workspace%%"},"event_class":"page","action":"tag_add"} |
| code-is   | 400                                              |                                                                                                                         |
| body-like | Missing required parameter 'page.id'             |                                                                                                                         |
| post-json | /data/events                                     | {"actor":{"id":1},"tag_name":"taggy","page":{"id":"meeting_agendas"},"event_class":"page","action":"tag_add"}           |
| code-is   | 400                                              |                                                                                                                         |
| body-like | Missing required parameter 'page.workspace_name' |                                                                                                                         |

| Comment        | GET/POST event by un-auth user |                                                                                                    |
| http-user-pass |                                |                                                                                                    |
| get            | /data/events                   | application/json                                                                                   |
| code-is        | 401                            |                                                                                                    |
| post-json      | /data/events                   | {"actor":{"id":1},"event_class":"person","action":"tag_add","person":{"id":2},"tag_name":"downer"} |
| code-is        | 401                            |                                                                                                    |

| Comment         | Set-up LDAP user                                   | .       |
| st-clear-events |                                                    |         |
| st_ldap         | start                                              |         |
| st_admin        | add-workspace-admin --w %%workspace%% --u devnull3 |         |
| http-user-pass  | devnull3                                           | ldapd3v |

| Comment    | post an event as the ldap user                      | .                                                                                                                             |
| post-json  | /data/events                                        | {"tag_name":"ldaptaggy","page":{"workspace_name":"%%workspace%%","id":"quick_start"},"event_class":"page","action":"tag_add"} |
| code-is    | 201                                                 |                                                                                                                               |
| get        | /data/events                                        | application/json                                                                                                              |
| json-parse |                                                     |                                                                                                                               |
| body-like  | "id":"quick_start"                                  |                                                                                                                               |
| body-like  | "tag_name":"ldaptaggy"                              |                                                                                                                               |
| body-like  | qr/"actor":{[^}]*"best_full_name":"Dev Null Three"/ |                                                                                                                               |

| *Comment* | ensure /data/events?event_class=person respects plugin enabledness | .                |
| st-admin  | disable-plugin --plugin people --account Socialtext                |                  |
| get       | /data/events?event_class=person                                    | application/json |
| code-is   | 403                                                                |                  |
| st-admin  | enable-plugin --plugin people --account Socialtext                 |                  |

^^ TODO Test

The following additional tests should be created:

* POST an event using form data
