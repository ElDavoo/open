* Fixture: SocialRest

| standard-test-setup |

| set | admin | admin%%start_time%%@q.q |
| create-user | %%admin%% | password | %%account%% |
| add-member | %%admin%% | %%workspace%% | admin |
| set | peon | peon%%start_time%%@q.q |
| create-user | %%peon%% | password | %%account%% |
| add-member | %%peon%% | %%workspace%% | member |

| http-user-pass | %%admin%% | password |
| GET | /data/workspaces/%%workspace%%/users | application/json|
| code-is | 200 |
| json-parse |
| json-array-size | 3 |
| json-like | [{"username":"%%username%%","role_name":"admin"},{"username":"%%admin%%","role_name":"admin"},{"username":"%%peon%%","role_name":"member","roles":["member"]}] |

* Add peon to some group
* Add that group to workpace A with role admin

| set                    | group         | %%start_time%% group! |                 |
| create-group           | %%group%%     |                       |                 |
| set                    | group_id1     | %%group_id%%          |                 |
| add-group-to-workspace | %%group_id1%% | %%workspace%%         | admin |
| add-user-to-group      | %%peon%%      | %%group_id1%%         |                 |

| http-user-pass | %%admin%% | password |
| GET | /data/workspaces/%%workspace%%/users | application/json|
| code-is | 200 |
| json-parse |
| json-array-size | 3 |
| json-like | [{"username":"%%username%%","role_name":"admin"},{"username":"%%admin%%","role_name":"admin"},{"username":"%%peon%%","role_name":"admin","roles":["member","admin"]}] |

| remove-member | %%peon%% | %%workspace%% |
| add-member | %%peon%% | %%workspace%% | impersonator |

| http-user-pass | %%admin%% | password |
| GET | /data/workspaces/%%workspace%%/users | application/json|
| code-is | 200 |
| json-parse |
| json-array-size | 3 |
| json-like | [{"username":"%%username%%","role_name":"admin"},{"username":"%%admin%%","role_name":"admin"},{"username":"%%peon%%","role_name":"impersonator","roles":["admin","impersonator"]}] |

| remove-member | %%peon%% | %%workspace%% |

| http-user-pass | %%admin%% | password |
| GET | /data/workspaces/%%workspace%%/users | application/json|
| code-is | 200 |
| json-parse |
| json-array-size | 3 |
| json-like | [{"username":"%%username%%","role_name":"admin"},{"username":"%%admin%%","role_name":"admin"},{"username":"%%peon%%","role_name":"admin","roles":["admin"]}] |

| add-member             | %%peon%% | %%workspace%% |
| remove-user-from-group | %%peon%% | %%group_id1%%     |

| http-user-pass | %%admin%% | password |
| GET | /data/workspaces/%%workspace%%/users | application/json|
| code-is | 200 |
| json-parse |
| json-array-size | 3 |
| json-like | [{"username":"%%username%%","role_name":"admin"},{"username":"%%admin%%","role_name":"admin"},{"username":"%%peon%%","role_name":"member","roles":["member"]}] |

| set                    | group2     | %%start_time%% group two! |              |
| create-group           | %%group2%% |                           |              |
| set                    | group_id2  | %%group_id%%              |              |
| add-group-to-workspace | %%group_id2%% | %%workspace%%             | impersonator |
| add-user-to-group      | %%peon%%   | %%group_id1%%                 |              |
| add-user-to-group      | %%peon%%   | %%group_id2%%                |              |

| http-user-pass | %%admin%% | password |
| GET | /data/workspaces/%%workspace%%/users | application/json|
| code-is | 200 |
| json-parse |
| json-array-size | 3 |
| json-like | [{"username":"%%username%%","role_name":"admin"},{"username":"%%admin%%","role_name":"admin"},{"username":"%%peon%%","role_name":"impersonator","roles":["member","admin","impersonator"]}] |

| remove-group-from-workspace | %%group_id2%% | %%workspace%% |
| remove-user-from-group | %%peon%% | %%group_id1%%     |

| http-user-pass | %%admin%% | password |
| GET | /data/workspaces/%%workspace%%/users | application/json|
| code-is | 200 |
| json-parse |
| json-array-size | 3 |
| json-like | [{"username":"%%username%%","role_name":"admin"},{"username":"%%admin%%","role_name":"admin"},{"username":"%%peon%%","role_name":"member","roles":["member"]}] |

| *Comment*   | Set-up for more ReST tests                     |                              |             |
| set         | member                                         | member%%start_time%%@q.q     |             |
| create-user | %%member%%                                     | password                     | %%account%% |
| add-member  | %%member%%                                     | %%workspace%%                | member      |
| set         | accounts_admin                                 | acct_admin%%start_time%%@q.q |             |
| create-user | %%accounts_admin%%                             | password                     | %%account%% |
| st-admin    | give-accounts-admin --email %%accounts_admin%% | now has                      |             |
| set         | system_admin                                   | sys_admin%%start_time%%@q.q  |             |
| create-user | %%system_admin%%                               | password                     | %%account%% |
| st-admin    | give-system-admin --email %%system_admin%%     | now has                      |             |

| *Comment*      | Workspace Admin can add a User to a Workspace |                               |                                                                                  |
| remove-member  | %%peon%%                                      | %%workspace%%                 |                                                                                  |
| http-user-pass | %%admin%%                                     | password                      |                                                                                  |
| POST           | /data/workspaces/%%workspace%%/users          | Content-Type=application/json | { "username":"%%peon%%", "rolename":"member", "send_confirmation_invitation":0 } |
| code-is        | 201                                           |                               |                                                                                  |

| *Comment*      | Accounts Admin can add a User to a Workspace |                               |                                                                                  |
| remove-member  | %%peon%%                                     | %%workspace%%                 |                                                                                  |
| http-user-pass | %%accounts_admin%%                           | password                      |                                                                                  |
| POST           | /data/workspaces/%%workspace%%/users         | Content-Type=application/json | { "username":"%%peon%%", "rolename":"member", "send_confirmation_invitation":0 } |
| code-is        | 201                                          |                               |                                                                                  |

| *Comment*      | System Admin can add a User to a Workspace |                               |                                                                                  |
| remove-member  | %%peon%%                                   | %%workspace%%                 |                                                                                  |
| http-user-pass | %%system_admin%%                           | password                      |                                                                                  |
| POST           | /data/workspaces/%%workspace%%/users       | Content-Type=application/json | { "username":"%%peon%%", "rolename":"member", "send_confirmation_invitation":0 } |
| code-is        | 201                                        |                               |                                                                                  |

| *Comment*      | Non-Admin *cannot* add a User to a Workspace |                               |                                                                                  |
| remove-member  | %%peon%%                                     | %%workspace%%                 |                                                                                  |
| http-user-pass | %%member%%                                   | password                      |                                                                                  |
| POST           | /data/workspaces/%%workspace%%/users         | Content-Type=application/json | { "username":"%%peon%%", "rolename":"member", "send_confirmation_invitation":0 } |
| code-is        | 403                                          |                               |                                                                                  |

| *Comment*      | Adding User to Workspace requires data |                               |     |
| http-user-pass | %%admin%%                              | password                      |     |
| POST           | /data/workspaces/%%workspace%%/users   | Content-Type=application/json | { } |
| code-is        | 400                                    |                               |     |

| *Comment*      | Workspace Admin can promote an existing Member to a WS Admin |                               |                                               |
| add-member     | %%peon%%                                                     | %%workspace%%                 |                                               |
| http-user-pass | %%admin%%                                                    | password                      |                                               |
| POST           | /data/workspaces/%%workspace%%/users                         | Content-Type=application/json | { "username":"%%peon%%", "rolename":"admin" } |
| code-is        | 201                                                          |                               |                                               |

| *Comment*      | Workspace Admin can remove a User from a Workspace |               |
| add-member     | %%peon%%                                           | %%workspace%% |
| http-user-pass | %%admin%%                                          | password      |
| DELETE         | /data/workspaces/%%workspace%%/users/%%peon%%      |               |
| code-is        | 204                                                |               |

| *Comment*      | Accounts Admin can remove a User from a Workspace |               |
| add-member     | %%peon%%                                          | %%workspace%% |
| http-user-pass | %%accounts_admin%%                                | password      |
| DELETE         | /data/workspaces/%%workspace%%/users/%%peon%%     |               |
| code-is        | 204                                               |               |

| *Comment*      | System Admin can remove a User from a Workspace |               |
| add-member     | %%peon%%                                        | %%workspace%% |
| http-user-pass | %%system_admin%%                                | password      |
| DELETE         | /data/workspaces/%%workspace%%/users/%%peon%%   |               |
| code-is        | 204                                             |               |

| *Comment*      | User can remove himself from a Workspace      |               |
| add-member     | %%peon%%                                      | %%workspace%% |
| http-user-pass | %%peon%%                                      | password      |
| DELETE         | /data/workspaces/%%workspace%%/users/%%peon%% |               |
| code-is        | 204                                           |               |

| *Comment*      | Non-Admin *cannot* remove a User from a Workspace |               |
| add-member     | %%peon%%                                          | %%workspace%% |
| http-user-pass | %%member%%                                        | password      |
| DELETE         | /data/workspaces/%%workspace%%/users/%%peon%%     |               |
| code-is        | 403                                               |               |

| *Comment*      | Can't remove a User that isn't in the Workspace |               |
| remove-member  | %%peon%%                                        | %%workspace%% |
| http-user-pass | %%admin%%                                       | password      |
| DELETE         | /data/workspaces/%%workspace%%/users/%%peon%%   |               |
| code-is        | 404                                             |               |

| *Comment*      | Can't query a User who isn't in the Workspace |               |
| remove-member  | %%peon%%                                      | %%workspace%% |
| http-user-pass | %%admin%%                                     | password      |
| GET            | /data/workspaces/%%workspace%%/users/%%peon%% |               |
| code-is        | 405                                           |               |
