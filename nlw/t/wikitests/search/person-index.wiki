* Fixture: Search

| standard-test-setup |

# Test person indexing

| st-clear-jobs   |             |                                        |
| set             | randy       | randy%%start_time%%@ken.socialtext.net |
| create-user     | %%randy%%   | password                               | %%account%% |
| job-count       | PersonIndex | 1                                      |
| st-process-jobs |             |                                        |
| job-count       | PersonIndex | 0                                      |

# can search them?
| search-people | randy%%start_time%% | 1 |

# Change some data
| http-user-pass | %%randy%% | password |
| post-json | /data/people/%%randy%% | {"first_name":"f%%start_time%%", "last_name":"l%%start_time%%", "gtalk_sn":"gtx%%start_time%%"} |
| code-is   | 204                    |                                                                                                |
| job-count       | PersonIndex | 1                                      |
| st-process-jobs |             |                                        |
| job-count       | PersonIndex | 0                                      |

| http-user-pass | %%randy%% | password |
| post-json | /data/people/%%randy%% | {"gtalk_sn":"gt%%start_time%%"} |
| code-is   | 204                    |                                                                                                |
| job-count       | PersonIndex | 1                                      |
| st-process-jobs |             |                                        |
| job-count       | PersonIndex | 0                                      |

# can search them?
| search-people | randy%%start_time%% | 1 |
| search-people | f%%start_time%% | 1 |
| search-people | l%%start_time%% | 1 |

# Search by gtalk works too
| search-people | gt%%start_time%% | 1 |

# Test UTF8 Characters
| post-json       | /data/people/%%randy%% | {"first_name":"Frëddy"} |
| code-is         | 204                    |                          |
| job-count       | PersonIndex            | 1                        |
| st-process-jobs |                        |                          |
| job-count       | PersonIndex            | 0                        |
| search-people | Frëddy | 1 |


# UTF8 in a tag
| post-json       | /data/people/%%randy%%/tags | {"tag_name":"über"} |
| code-is         | 204                         |                      |
| job-count       | PersonIndex                 | 1                    |
| st-process-jobs |                             |                      |
| job-count       | PersonIndex                 | 0                    |

# UTF8 in a profile field
| post-json       | /data/people/%%randy%% | {"gtalk_sn":"haxør"} |
| code-is         | 204                    |                       |
| job-count       | PersonIndex            | 1                     |
| st-process-jobs |                        |                       |
| job-count       | PersonIndex            | 0                     |

# Changing a primary account re-indexes the user
| set | account2 | acct2%%start_time%% |
| create-account | %%account2%% |
| user-primary-account | %%randy%% | %%account2%% |
| job-count       | PersonIndex            | 1                     |
| st-process-jobs |                        |                       |
| job-count       | PersonIndex            | 0                     |

# Tagging a user

| post | /data/people/%%randy%%/tags | Content-Type=application/json | {"tag_name":"obamamama"} |
| code-is | 204 |
| job-count       | PersonIndex            | 1                     |
| st-process-jobs |                        |                       |
| job-count       | PersonIndex            | 0                     |


# This next test should come last

# Deactivating a user makes them not searchable
| deactivate-user | %%randy%%       |   |
| job-count       | PersonIndex     | 1 |
| st-process-jobs |                 |   |
| job-count       | PersonIndex     | 0 |
| search-people   | f%%start_time%% | 0 |

