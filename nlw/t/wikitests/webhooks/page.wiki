* Fixture: WebHook

| standard-test-setup | foo               |     |                |
| standard-test-setup | bar               |     |                |
| set-business-admin  | %%bar_email_address%% | 1   |                |
| edit-page           | %%bar_workspace%%     | Foo | Sample Content |
| clear-webhooks      |                   |     |                |

| comment |  Tag a page, verify no webhooks fired |
| st-clear-jobs |               |     |                |
| PUT | /data/workspaces/%%bar_workspace%%/pages/Foo/tags/bar | | |
| code-is | 201 |
| job-count     | WebHook   | 0   |                |

| comment               | Add a webhook, Tag a page, verify webhook fires                                     |               |                                         |
| st-clear-jobs         |                                                                                     |               |                                         |
| add-webhook           | page.tag                                                                            | http://tou.ch | {"workspace_id":"%%bar_workspace_id%%"} |
| PUT                   | /data/workspaces/%%bar_workspace%%/pages/Foo/tags/baz                               |               |                                         |
| code-is               | 201                                                                                 |               |                                         |
| clear-webhook         |                                                                                     |               |                                         |
| job-count             | WebHook                                                                             | 1             |                                         |
| st-process-jobs       |                                                                                     |               |                                         |
| job-count             | WebHook                                                                             | 0             |                                         |
| webhook-payload-parse |                                                                                     |               |                                         |
| json-like             | {"class":"page.tag"}                                                                |               |                                         |
| json-like             | {"actor":{"id":%%user_id%%,"best_full_name":"bar user %%start_time%%"}}             |               |                                         |
| json-like             | {"object":{"editor":{"id":%%user_id%%,"best_full_name":"bar user %%start_time%%"}}} |               |                                         |
| json-like             | {"object":{"workspace":{"title":"%%bar_workspace%%","name":"%%bar_workspace%%"}}}   |               |                                         |
| json-like             | {"object":{"id":"foo"}}                                                             |               |                                         |
| json-like             | {"object":{"name":"Foo"}}                                                           |               |                                         |
| json-like             | {"object":{"uri":"%%browser_url%%/%%bar_workspace%%/index.cgi?foo"}}                |               |                                         |
| json-like             | {"object":{"edit_summary":""}}                                                      |               |                                         |
| json-like             | {"object":{"tags":["baz"]}}                                                         |               |                                         |
| json-like             | {"object":{"tags_added":["baz"]}}                                                   |               |                                         |
| json-like             | {"object":{"tags_deleted":[]}}                                                      |               |                                         |
| json-like             | {"object":{"type":"wiki"}}                                                          |               |                                         |

| comment               | Delete a tag, verify webhook fires                    |   |
| st-clear-jobs         |                                                       |   |
| DELETE                | /data/workspaces/%%bar_workspace%%/pages/Foo/tags/baz |   |
| code-is               | 204                                                   |   |
| job-count             | WebHook                                               | 1 |
| clear-webhook         |                                                       |   |
| st-process-jobs       |                                                       |   |
| job-count             | WebHook                                               | 0 |
| webhook-payload-parse |                                                       |   |
| json-like             | {"class":"page.tag"}                                  |   |
| json-like             | {"object":{"tags":[]}}                                |   |
| json-like             | {"object":{"tags_added":[]}}                          |   |
| json-like             | {"object":{"tags_deleted":["baz"]}}                   |   |

| comment          | Tag a page in a different workspace         |                    |                |
| set              | ws2                                         | ws2-%%start_time%% |                |
| create-workspace | %%ws2%%                                     |                    |                |
| add-member       | %%bar_email_address%%                       | %%ws2%%            |                |
| edit-page        | %%ws2%%                                     | Foo2               | Sample Content |
| st-clear-jobs    |                                             |                    |                |
| PUT              | /data/workspaces/%%ws2%%/pages/Foo/tags/baz |                    |                |
| code-is          | 201                                         |                    |                |
| job-count        | WebHook                                     | 0                  |                |

| comment            | Create a workspace_id filtered webhook as a non-badmin     |               |                                         |
| set-business-admin | %%bar_email_address%%                                      | 0             |                                         |
| clear-webhooks     |                                                            |               |                                         |
| st-clear-jobs      |                                                            |               |                                         |
| add-webhook        | page.tag                                                   | http://tou.ch | {"workspace_id":"%%bar_workspace_id%%"} |
| PUT                | /data/workspaces/%%bar_workspace%%/pages/Foo/tags/bazafraz |               |                                         |
| code-is            | 201                                                        |               |                                         |
| job-count          | WebHook                                                    | 1             |                                         |

| comment   | Creating an workspace_id filtered webhook as a user not in that workspace |                                                                                  |
| POST_json | /data/webhooks                                                            | {"class":"page.tag","url":"http://tou.ch","workspace_id":"%%foo_workspace_id%%"} |
| code-is   | 403                                                                       |                                                                                  |

| comment        | Use an account_id filtered webhook                       |               |                                     |
| clear-webhooks |                                                          |               |                                     |
| st-clear-jobs  |                                                          |               |                                     |
| add-webhook    | page.tag                                                 | http://tou.ch | {"account_id":"%%bar_account_id%%"} |
| PUT            | /data/workspaces/%%bar_workspace%%/pages/Foo/tags/bazzer |               |                                     |
| code-is        | 201                                                      |               |                                     |
| job-count      | WebHook                                                  | 1             |                                     |

| comment            | Creating an account_id filtered webhook as a non-badmin   |               |                                     |
| set-business-admin | %%bar_email_address%%                                     | 0             |                                     |
| clear-webhooks     |                                                           |               |                                     |
| st-clear-jobs      |                                                           |               |                                     |
| add-webhook        | page.tag                                                  | http://tou.ch | {"account_id":"%%bar_account_id%%"} |
| PUT                | /data/workspaces/%%bar_workspace%%/pages/Foo/tags/berzerk |               |                                     |
| code-is            | 201                                                       |               |                                     |
| job-count          | WebHook                                                   | 1             |                                     |

| comment   | Creating an account_id filtered webhook as a user not in that account |                                                                              |
| POST_json | /data/webhooks                                                        | {"class":"page.tag","url":"http://tou.ch","account_id":"%%foo_account_id%%"} |
| code-is   | 403                                                                   |                                                                              |

| comment            | Try adding an invalid webhook class |                                                     |
| set-business-admin | %%bar_email_address%%               | 1                                                   |
| POST_json          | /data/webhooks                      | {"class":"page.nothing","url":"http://example.com"} |
| code-is            | 400                                 |                                                     |
| body-like          | not a valid webhook                 |                                                     |

