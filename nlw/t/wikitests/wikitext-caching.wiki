* Fixture: WikitextCaching

| standard-test-setup |
| set | ws1_id | %%workspace_id%% |

Create another user in the same workspace as the main user
| set | user2 | user2-%%start_time%%@ken.socialtext.net |
| create-user | %%user2%% | password | %%account%% |
| add-member | %%user2%% | %%workspace%% |

Create another workspace just for the main user.
| set | ws2 | ws2-%%start_time%% |
| create-workspace | %%ws2%% |
| set | ws2_id | %%workspace_id%% |
| add-member | %%username%% | %%ws2%% |

Create another account and another user that is in the same group as user1
This should give username visibility of foo_username
| standard-test-setup | foo |
| add_user_to_group | %%username%% | %%foo_group_id%% |

Run these tests as the main user.
| http-user-pass | %%username%% | password |

| Comment    | Create and fetch the simplest possible page    |
| edit_page  | %%workspace%%          | Test | Simplest page possible. |
| fetch-page | Test                   | hit  |                         |
| body-like  | Simplest page possible |      |                         |

| cache-created-ok | %%workspace%% |
| question-file-is | Test | null |

| Comment    | fetch it again, make sure it's cached again |     |
| fetch-page | Test                                        | hit |


| Comment    | Create and fetch a page with an intra-ws link |
| edit_page  | %%workspace%% | Test2 | This has [one link]. |
| fetch-page | Test2         | hit   |                      |

| cache-created-ok | %%workspace%% |
| question-file-is | Test2 | null |


| Comment    | Create and fetch a page with an inter-ws link |
| edit_page  | %%workspace%% | Test3 | See {link: %%ws2%% [this page]}. |
| fetch-page | Test3         | hit   |                                  |
| body-like  | href="/%%ws2%%/index.cgi?this%20page">this page</a> |

| cache-created-ok | %%workspace%% |
| question-file-is | Test3 | w%%ws2_id%% |

| Comment | Now view this page from the other user without access |
| http-user-pass | %%user2%% | password |
| fetch-page     | Test3     | miss     |
| body-like  | <span class="wafl_permission_error">this page</span> |

| Comment    | View it a second time, it should be cached |     |
| fetch-page | Test3                                      | hit |
| body-like  | <span class="wafl_permission_error">this page</span> |

| Comment | Clear out the cache, verify it is re-generated |
| http-user-pass       | %%username%%  | password |             |
| clear-wikitext-cache |               |          |             |
| fetch-page           | Test3         | miss     |             |
| question-file-is     | Test3    | w%%ws2_id%% |
| fetch-page           | Test3         | hit      |             |


| Comment  | Allows HTML wafl preference                              |
| st-admin | set-workspace-config -w %%workspace%% allows_html_wafl 1 |
| edit_page  | %%workspace%% | Test4 | Test\n.html\n<strong>hai</strong>\n.html\n |
| fetch-page       | Test4         | hit   |             |
| question-file-is | Test4 | h%%ws1_id%% |
| body-like   | <div class="wafl_block"><strong>hai</strong>             |      |
| st-admin    | set-workspace-config -w %%workspace%% allows_html_wafl 0 |      |
| fetch-page  | Test4                                                    | miss |
| body-unlike | <div class="wafl_block"><strong>hai</strong>             |      |
| body-like   | &lt;strong&gt;hai&lt;/strong&gt;                         |      |
| fetch-page  | Test4                                                    | hit  |
| body-unlike | <div class="wafl_block"><strong>hai</strong>             |      |
| body-like   | &lt;strong&gt;hai&lt;/strong&gt;                         |      |
| st-admin    | set-workspace-config -w %%workspace%% allows_html_wafl 1 |      |
| fetch-page  | Test4                                                    | hit  |
| body-like   | <div class="wafl_block"><strong>hai</strong>             |      |


| Comment            | RSS Feeds     |         |      |
| edit-page          | %%workspace%% | RSSTest | {fetchrss: http://www.socialtext.com/blog/atom.xml} |
| fetch-page         | RSSTest | hit      |
| question-file-like | RSSTest | qr/E\d+/ |
| set-question-file  | RSSTest | E0       |
| fetch-page         | RSSTest | miss     |
| fetch-page         | RSSTest | hit      |

| Comment            | Google searches |
| edit-page          | %%workspace%% | GoogleTest | {googlesearch: Socialtext} |
| fetch-page         | GoogleTest | hit      |
| question-file-like | RSSTest | qr/E\d+/ |

| Comment   | User Wafls    |          |                            |
| edit-page | %%workspace%% | usertest | Hi {user: %%foo_user_id%%} |
| fetch-page | usertest                        | hit |
| body-like  | <span class="person authorized" |     |
| question-file-is | usertest                          | u%%foo_user_id%% |
| http-user-pass   | %%user2%%                         | password         |
| fetch-page       | usertest                          | miss             |
| body-unlike      | <span class="person authorized"   |                  |
| body-like        | <span class="person unauthorized" |                  |

^^ To Test

** included pages and spreadsheets
** Any links or WAFLS whose "More Options" can include a workspace:
*** TOC links
*** Tag/Weblog links
*** Tag/Weblog lists
*** Recent Changes
*** Wiki Search
*** links to attachments in other workspaces

Is there anything to this?
* web links to images (any external content)

Really Tricky Cases:
* Page includes
** allows_html for included pages?
